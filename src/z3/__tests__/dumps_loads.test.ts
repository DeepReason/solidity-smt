import makeZ3, { Z3Obj } from "../z3";
import { dumps_expr, loads_expr, loads_model } from "../dumps_loads";
import { Expr } from "z3-solver";

describe("Dump/Load String Testing", () => {

  let z3: Z3Obj;

  beforeAll(async () => {
    z3 = await makeZ3();
  });

  it("Solving", async () => {
    const s = new z3.Solver();
    const x = z3.BitVec.const("x", 256);
    const y = z3.BitVec.const("y", 256);
    s.add(x.eq(y));
    const cr = await s.check();
    expect(cr).toEqual("sat");
  });

  it("Loading model", async () => {
    const str = "(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256)))) Bool) (declare-fun global_storage@init () (Array (_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256)))) (assert (__deepreason__placeholder__ global_storage@init)) ::(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256)))) Bool) (assert (__deepreason__placeholder__ ((as const (Array (_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256)))) ((as const (Array (_ BitVec 256) (_ BitVec 256))) #x0000000000000000000000000000000000000000000000000000000000000000)))) ;(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (_ BitVec 256))) Bool) (declare-fun balances@before () (Array (_ BitVec 160) (_ BitVec 256))) (assert (__deepreason__placeholder__ balances@before)) ::(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (_ BitVec 256))) Bool) (assert (let ((a!1 (store (store (store ((as const (Array (_ BitVec 160) (_ BitVec 256))) #x0000000000000000000000000000000000000000000000000000000000000001) #x0000000000000000000000000000002000000000 #x0000000000000000000000000000000000000000000800000000000000000000) #x0000000000000000000002000000000000000000 #x000000000000000000000000000000000000000000189c046a859020c8488421) #x0400000000000000000000000000000000000000 #x00000000000000000000000000000000000000000018000000000084c0680001))) (__deepreason__placeholder__ (store (store a!1 #x0000000000000000000000000000000000000000 #x0000000000000000000000000000000000000000000004000002200200001045) #x0000000000000000000000000000000000004000 #x0000000000000000000000000000000000000000000a01880cc458020c0e2804)))) ;(declare-fun __deepreason__placeholder__ ((_ BitVec 160)) Bool) (declare-fun gen_itxn_send_no_fallback_rec () (_ BitVec 160)) (assert (__deepreason__placeholder__ gen_itxn_send_no_fallback_rec)) ::(declare-fun __deepreason__placeholder__ ((_ BitVec 160)) Bool) (assert (__deepreason__placeholder__ #x0000000000000000000000000000000000000000)) ;(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (_ BitVec 256))) Bool) (declare-fun nonces@init () (Array (_ BitVec 160) (_ BitVec 256))) (assert (__deepreason__placeholder__ nonces@init)) ::(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (_ BitVec 256))) Bool) (assert (__deepreason__placeholder__ (store ((as const (Array (_ BitVec 160) (_ BitVec 256))) #x0000000000000000000000000000000000000000000000000000000000000000) #x0000000000000000000000000000000000000000 #x0000000000000000000000000000000000000000000000000000000000000001))) ;(declare-fun __deepreason__placeholder__ ((_ BitVec 160)) Bool) (declare-fun sender () (_ BitVec 160)) (assert (__deepreason__placeholder__ sender)) ::(declare-fun __deepreason__placeholder__ ((_ BitVec 160)) Bool) (assert (__deepreason__placeholder__ #x0400000000000000000000000000000000000000)) ;(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256)))) Bool) (declare-fun global_storage@after () (Array (_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256)))) (assert (__deepreason__placeholder__ global_storage@after)) ::(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256)))) Bool) (assert (let ((a!1 (store (store (store ((as const (Array (_ BitVec 256) (_ BitVec 256))) #x0000000000000000000000000000000000000000000000000000000000000001) #x0000000000000000000000000000000100000000000000000000000000000000 #x0000000000000000000000000000000000000000000000000000000040000000) #x0000000000000000000000000000000000000000000000000000080000000000 #x0000c04000000ffffffffffffffffffffffffffffff00405c000000088499462) #x0000000000000000000000100000000000000000000000000000000000000000 #x00004080010444407809c1a2e29000220144800290f64003240a000e07630060))) (__deepreason__placeholder__ ((as const (Array (_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256)))) (store (store a!1 #x0000000000000000000000001000000000000000000000000000000000000000 #xffffffffffffffffffffffffffffffffffffffffffe8000000000f7b40140000) #x0000000000000000000000000000000000000000000000000000000040000000 #x000015380819245829406090c288004231c30140210199480410022405100502))))) ;(declare-fun __deepreason__placeholder__ ((_ BitVec 160)) Bool) (declare-fun deployer () (_ BitVec 160)) (assert (__deepreason__placeholder__ deployer)) ::(declare-fun __deepreason__placeholder__ ((_ BitVec 160)) Bool) (assert (__deepreason__placeholder__ #x0000000000000000000000000020000000000000)) ;(declare-fun __deepreason__placeholder__ ((_ BitVec 256)) Bool) (declare-fun gen_itxn_send_no_fallback_v () (_ BitVec 256)) (assert (__deepreason__placeholder__ gen_itxn_send_no_fallback_v)) ::(declare-fun __deepreason__placeholder__ ((_ BitVec 256)) Bool) (assert (__deepreason__placeholder__ #x0000000000000000000000000000000000000000001700000000000000000000)) ;(declare-fun __deepreason__placeholder__ ((_ BitVec 160)) Bool) (declare-fun __deepreason_qvar__a__0 () (_ BitVec 160)) (assert (__deepreason__placeholder__ __deepreason_qvar__a__0)) ::(declare-fun __deepreason__placeholder__ ((_ BitVec 160)) Bool) (assert (__deepreason__placeholder__ #x0400000000000000000000000000000000000000)) ;(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (_ BitVec 256))) Bool) (declare-fun call_count@after () (Array (_ BitVec 160) (_ BitVec 256))) (assert (__deepreason__placeholder__ call_count@after)) ::(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (_ BitVec 256))) Bool) (assert (let ((a!1 (store (store (store ((as const (Array (_ BitVec 160) (_ BitVec 256))) #x0000000000000000000000000000000000000000001700000000000000000000) #x0000000000000000000000000000000020000000 #x0000000000000000000000000000000000000000000020000000000000000000) #x0000000020000000000000000000000000000000 #x0000000000000000000000000000000000000000000000000000000000080000) #x0000000000000000000000000000000000000000 #x0000000000000000000000000000000000000000000af94454d14c11158e6e08))) (__deepreason__placeholder__ a!1))) ;(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (_ BitVec 256))) Bool) (declare-fun call_count@before () (Array (_ BitVec 160) (_ BitVec 256))) (assert (__deepreason__placeholder__ call_count@before)) ::(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (_ BitVec 256))) Bool) (assert (let ((a!1 (store (store (store ((as const (Array (_ BitVec 160) (_ BitVec 256))) #x0000000000000000000000000000000000000000001700000000000000000000) #x0000000000000000000000000000000020000000 #x0000000000000000000000000000000000000000000020000000000000000000) #x0000000020000000000000000000000000000000 #x0000000000000000000000000000000000000000000000000000000000080000) #x0000000000000000000000000000000000000000 #x0000000000000000000000000000000000000000000af94454d14c11158e6e08))) (__deepreason__placeholder__ a!1))) ;(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (_ BitVec 256))) Bool) (declare-fun nonces@after () (Array (_ BitVec 160) (_ BitVec 256))) (assert (__deepreason__placeholder__ nonces@after)) ::(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (_ BitVec 256))) Bool) (assert (__deepreason__placeholder__ ((as const (Array (_ BitVec 160) (_ BitVec 256))) #x0000000000000000000000000000000000000000000000000000000000000000))) ;(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (_ BitVec 256))) Bool) (declare-fun nonces@before () (Array (_ BitVec 160) (_ BitVec 256))) (assert (__deepreason__placeholder__ nonces@before)) ::(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (_ BitVec 256))) Bool) (assert (__deepreason__placeholder__ ((as const (Array (_ BitVec 160) (_ BitVec 256))) #x0000000000000000000000000000000000000000000000000000000000000000))) ;(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256)))) Bool) (declare-fun global_storage@before () (Array (_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256)))) (assert (__deepreason__placeholder__ global_storage@before)) ::(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256)))) Bool) (assert (let ((a!1 (store (store (store ((as const (Array (_ BitVec 256) (_ BitVec 256))) #x0000000000000000000000000000000000000000000000000000000000000001) #x0000000000000000000000000000000100000000000000000000000000000000 #x0000000000000000000000000000000000000000000000000000000040000000) #x0000000000000000000000000000000000000000000000000000080000000000 #x0000c04000000ffffffffffffffffffffffffffffff00405c000000088499462) #x0000000000000000000000100000000000000000000000000000000000000000 #x00004080010444407809c1a2e29000220144800290f64003240a000e07630060))) (__deepreason__placeholder__ ((as const (Array (_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256)))) (store (store a!1 #x0000000000000000000000001000000000000000000000000000000000000000 #xffffffffffffffffffffffffffffffffffffffffffe8000000000f7b40140000) #x0000000000000000000000000000000000000000000000000000000040000000 #x000015380819245829406090c288004231c30140210199480410022405100502))))) ;(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (_ BitVec 256))) Bool) (declare-fun balances@after () (Array (_ BitVec 160) (_ BitVec 256))) (assert (__deepreason__placeholder__ balances@after)) ::(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 160) (_ BitVec 256))) Bool) (assert (let ((a!1 (store (store (store ((as const (Array (_ BitVec 160) (_ BitVec 256))) #x0000000000000000000000000000000000000000000000000000000000000001) #x0000000000000000000000000000002000000000 #x0000000000000000000000000000000000000000000800000000000000000000) #x0000000000000000000002000000000000000000 #x000000000000000000000000000000000000000000189c046a859020c8488421) #x0400000000000000000000000000000000000000 #x00000000000000000000000000000000000000000018000000000084c0680001))) (let ((a!2 (store (store (store (store a!1 #x0000000000000000000000000000000000000000 #x0000000000000000000000000000000000000000000004000002200200001045) #x0000000000000000000000000000000000004000 #x0000000000000000000000000000000000000000000a01880cc458020c0e2804) #x0000000000000000000000000000000000000000 #x0000000000000000000000000000000000000000001704000002200200001045) #x0400000000000000000000000000000000000000 #x00000000000000000000000000000000000000000001000000000084c0680001))) (__deepreason__placeholder__ a!2)))) ;(declare-fun __deepreason__placeholder__ ((_ BitVec 160)) Bool) (declare-fun VaultBasic_addr () (_ BitVec 160)) (assert (__deepreason__placeholder__ VaultBasic_addr)) ::(declare-fun __deepreason__placeholder__ ((_ BitVec 160)) Bool) (assert (__deepreason__placeholder__ #x0000000000000000000000000000000000000000)) ;(declare-fun __deepreason__placeholder__ ((_ BitVec 256)) Bool) (declare-fun create_VaultBasic_t1_v () (_ BitVec 256)) (assert (__deepreason__placeholder__ create_VaultBasic_t1_v)) ::(declare-fun __deepreason__placeholder__ ((_ BitVec 256)) Bool) (assert (__deepreason__placeholder__ #x0000000000000000000000000000000000000000000000000000000000000000)) ;(declare-fun __deepreason__placeholder__ ((_ BitVec 160)) Bool) (declare-fun f_input_1 () (Array (_ BitVec 160) (_ BitVec 256))) (declare-fun f_input_0 () (Array (_ BitVec 160) (_ BitVec 256))) (assert (__deepreason__placeholder__ ((_ array-ext 0) f_input_0 f_input_1))) ::&(declare-fun __deepreason__placeholder__ ((Array (Array (_ BitVec 160) (_ BitVec 256)) (Array (_ BitVec 160) (_ BitVec 256)) (_ BitVec 160))) Bool) (assert (__deepreason__placeholder__ (lambda ((__deepreason_f_input_0 (Array (_ BitVec 160) (_ BitVec 256))) (__deepreason_f_input_1 (Array (_ BitVec 160) (_ BitVec 256)))) #x0000000000000000000000000000000000000000))) ;(declare-fun __deepreason__placeholder__ ((_ BitVec 256)) Bool) (declare-fun keccak256_512 ((_ BitVec 512)) (_ BitVec 256)) (declare-fun f_input_0 () (_ BitVec 512)) (assert (__deepreason__placeholder__ (keccak256_512 f_input_0))) ::&(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 512) (_ BitVec 256))) Bool) (assert (let ((a!1 (lambda ((__deepreason_f_input_0 (_ BitVec 512))) (let ((a!1 (ite (and (= __deepreason_f_input_0 #x00000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002) (not (= __deepreason_f_input_0 #x00000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000002)) (not (= __deepreason_f_input_0 #x00000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000002))) #x0000000000000000000000001000000000000000000000000000000000000000 #x0000000000000000000000000000000000000000000000000000000000000003))) (let ((a!2 (ite (and (not (= __deepreason_f_input_0 #x00000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000002)) (not (= __deepreason_f_input_0 #x00000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002)) (not (= __deepreason_f_input_0 #x00000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000002)) (not (= __deepreason_f_input_0 #x00000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000002))) #x0000000000000000000000000000000000000000000000000000000040000000 a!1))) (let ((a!3 (ite (and (= __deepreason_f_input_0 #x00000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000002) (not (= __deepreason_f_input_0 #x00000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000002))) #x0000000000000000000000000000000100000000000000000000000000000000 (ite (= __deepreason_f_input_0 #x00000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000002) #x0000000000000000000000100000000000000000000000000000000000000000 a!2)))) (ite (and (= __deepreason_f_input_0 #x00000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000002) (not (= __deepreason_f_input_0 #x00000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002)) (not (= __deepreason_f_input_0 #x00000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000002)) (not (= __deepreason_f_input_0 #x00000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000002))) #x0000000000000000000000000000000000000000000000000000080000000000 a!3))))))) (__deepreason__placeholder__ a!1))) ;(declare-fun __deepreason__placeholder__ ((_ BitVec 256)) Bool) (declare-fun keccak256_424 ((_ BitVec 424)) (_ BitVec 256)) (declare-fun f_input_0 () (_ BitVec 424)) (assert (__deepreason__placeholder__ (keccak256_424 f_input_0))) ::&(declare-fun __deepreason__placeholder__ ((_ BitVec 424)) Bool) (assert (__deepreason__placeholder__ #xb400000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000)) ->(declare-fun __deepreason__placeholder__ ((_ BitVec 256)) Bool) (assert (__deepreason__placeholder__ #x0000000000008000000000000000000000000000000000000000000000000000)) &(declare-fun __deepreason__placeholder__ ((Array (_ BitVec 424) (_ BitVec 256))) Bool) (assert (__deepreason__placeholder__ (lambda ((__deepreason_f_input_0 (_ BitVec 424))) #x0000000000000000000000000000000000000000000000000000000000100000)))";
    const m = await loads_model(z3, str);
    // console.log(m);
  });

  it("Loading expr", async () => {
    const s = "(declare-fun __deepreason__placeholder__ (Int Int Int) Bool) (declare-fun z () Int) (declare-fun y () Int) (declare-fun x () Int) (assert (__deepreason__placeholder__ x y (+ (* x y) z)))"
    const exprs = loads_expr(z3, s) as Expr[];
    expect(exprs.length).toEqual(3);
  });

  it("Empty dumps", async () => {
    const s = dumps_expr([]);
    expect((loads_expr(z3, s) as Expr[]).length == 0);
  });

});