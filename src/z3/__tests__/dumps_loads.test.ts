import makeZ3, { Z3Obj } from '../z3';
import { loads_model } from '../dumps_loads';

describe('Dump/Load String Testing', () => {

  let z3: Z3Obj;

  beforeAll(async () => {
    z3 = await makeZ3();
  });

  it('Solving', async () => {
    const s = new z3.Solver();
    const x = z3.BitVec.const('x', 256);
    const y = z3.BitVec.const('y', 256);
    s.add(x.eq(y));
    const cr = await s.check();
    expect(cr).toEqual('sat');
  });

  it('Loading model', async () => {
    const str = '(declare-fun |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))| ' +
      '             ()              (Array (_ BitVec 160) (_ BitVec 256))) (declare-fun balances@after () (Array (_ BitVec 160) (_ BitVec 256))) ' +
      '(assert (= balances@after |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|)) :(declare-fun ' +
      '|__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|              ()              (Array (_ BitVec 160)' +
      ' (_ BitVec 256))) (assert (= (store (store ((as const (Array (_ BitVec 160) (_ BitVec 256)))               ' +
      '     #x0000000000000000000000000000000000000000000000000000000000000000)                 ' +
      ' #x0000000000000000000000000000000000000002                  ' +
      '#x0000000000000000000000000000000001000000000000000002000000000001)           ' +
      '#x0000000000000000000000000000000000000000           ' +
      '#x0000000000000000000000000000000000000000000000000000000000000001)    ' +
      '|__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|)) ;(declare-fun |__deepreason_expr_tmp_Array(BitVec(160),' +
      ' BitVec(256))|              ()              (Array (_ BitVec 160) (_ BitVec 256))) ' +
      '(declare-fun balances@before () (Array (_ BitVec 160) (_ BitVec 256))) (assert (= balances@before ' +
      '|__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|)) :(declare-fun |__deepreason_expr_tmp_Array(BitVec(160),' +
      ' BitVec(256))|              ()              (Array (_ BitVec 160) (_ BitVec 256))) (assert (= (store (store ((as' +
      ' const (Array (_ BitVec 160) (_ BitVec 256)))                  ' +
      ' #x0000000000000000000000000000000000000000000000000000000000000000)                ' +
      '  #x0000000000000000000000000000000000000002                  ' +
      '#x8000000000000000000000000000000000000000000000000000000000000000)           ' +
      '#x0000000000000000000000000000000000000000           ' +
      '#x8000000000000000000000000000000001000000000000000002000000000002)    |__deepreason_expr_tmp_Array(BitVec(160),' +
      ' BitVec(256))|)) ;(declare-fun |__deepreason_expr_tmp_BitVec(160)| () (_ BitVec 160)) ' +
      '(declare-fun gen_itxn_send_no_fallback_rec () (_ BitVec 160)) (assert (= gen_itxn_send_no_fallback_rec ' +
      '|__deepreason_expr_tmp_BitVec(160)|)) :(declare-fun |__deepreason_expr_tmp_BitVec(160)| () (_ BitVec 160)) ' +
      '(assert (= #x0000000000000000000000000000000000000000    |__deepreason_expr_tmp_BitVec(160)|)) ;(declare-fun ' +
      '|__deepreason_expr_tmp_Array(BitVec(160), Array(BitVec(256), BitVec(256)))|              ()              (Array ' +
      '(_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256)))) (declare-fun global_storage@after              ()   ' +
      '           (Array (_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256)))) (assert (= global_storage@after    ' +
      '|__deepreason_expr_tmp_Array(BitVec(160), Array(BitVec(256), BitVec(256)))|)) ' +
      ':(declare-fun |__deepreason_expr_tmp_Array(BitVec(160), Array(BitVec(256), BitVec(256)))|              ' +
      '()              (Array (_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256)))) (assert (= (store ((as const    ' +
      '            (Array (_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256))))             ((as const (Array (_ ' +
      'BitVec 256) (_ BitVec 256)))               #x8000000000000000000000000000000000000000000000000000000000000000)) ' +
      '          #xfffffffffffffffffffffffffffffffffffffffd           (store ((as const (Array (_ BitVec 256) (_ BitVec' +
      ' 256)))                    #x8000000000000000000000000000000000000000000000000000000000000000)                  ' +
      '#x0000000000000000000000000000000000000000000000000000000000000000                  ' +
      '#x0000000000000000000000000000000000000000000000000000000000000001))    |__deepreason_expr_tmp_Array(BitVec(160), ' +
      'Array(BitVec(256), BitVec(256)))|)) ;(declare-fun |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|              ()              (Array (_ BitVec 160) (_ BitVec 256))) (declare-fun balances@init () (Array (_ BitVec 160) (_ BitVec 256))) (assert (= balances@init |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|)) :(declare-fun |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|              ()              (Array (_ BitVec 160) (_ BitVec 256))) (assert (= ((as const (Array (_ BitVec 160) (_ BitVec 256)))      #x0000000000000000000000000000000000000000000000000000000000000000)    |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|)) ;(declare-fun |__deepreason_expr_tmp_BitVec(160)| () (_ BitVec 160)) (declare-fun sender () (_ BitVec 160)) (assert (= sender |__deepreason_expr_tmp_BitVec(160)|)) :(declare-fun |__deepreason_expr_tmp_BitVec(160)| () (_ BitVec 160)) (assert (= #x0000000000000000000000000000000000000002    |__deepreason_expr_tmp_BitVec(160)|)) ;(declare-fun |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|              ()              (Array (_ BitVec 160) (_ BitVec 256))) (declare-fun nonces@before () (Array (_ BitVec 160) (_ BitVec 256))) (assert (= nonces@before |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|)) :(declare-fun |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|              ()              (Array (_ BitVec 160) (_ BitVec 256))) (assert (= ((as const (Array (_ BitVec 160) (_ BitVec 256)))      #x8000000000000000000000000000000000000000000000000000000000000000)    |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|)) ;(declare-fun |__deepreason_expr_tmp_BitVec(160)| () (_ BitVec 160)) (declare-fun deployer () (_ BitVec 160)) (assert (= deployer |__deepreason_expr_tmp_BitVec(160)|)) :(declare-fun |__deepreason_expr_tmp_BitVec(160)| () (_ BitVec 160)) (assert (= #x4000000000000000000000000000000000000000    |__deepreason_expr_tmp_BitVec(160)|)) ;(declare-fun |__deepreason_expr_tmp_BitVec(160)| () (_ BitVec 160)) (declare-fun Spec_t1 () (_ BitVec 160)) (assert (= Spec_t1 |__deepreason_expr_tmp_BitVec(160)|)) :(declare-fun |__deepreason_expr_tmp_BitVec(160)| () (_ BitVec 160)) (assert (= #x0000000000000000000000000000000000000000    |__deepreason_expr_tmp_BitVec(160)|)) ;(declare-fun |__deepreason_expr_tmp_BitVec(256)| () (_ BitVec 256)) (declare-fun gen_itxn_send_no_fallback_v () (_ BitVec 256)) (assert (= gen_itxn_send_no_fallback_v |__deepreason_expr_tmp_BitVec(256)|)) :(declare-fun |__deepreason_expr_tmp_BitVec(256)| () (_ BitVec 256)) (assert (= #x7ffffffffffffffffffffffffffffffffefffffffffffffffffdffffffffffff    |__deepreason_expr_tmp_BitVec(256)|)) ;(declare-fun |__deepreason_expr_tmp_BitVec(256)| () (_ BitVec 256)) (declare-fun create_Spec_t1_v () (_ BitVec 256)) (assert (= create_Spec_t1_v |__deepreason_expr_tmp_BitVec(256)|)) :(declare-fun |__deepreason_expr_tmp_BitVec(256)| () (_ BitVec 256)) (assert (= #x0000000000000000000000000000000000000000000000000000000000000000    |__deepreason_expr_tmp_BitVec(256)|)) ;(declare-fun |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|              ()              (Array (_ BitVec 160) (_ BitVec 256))) (declare-fun call_count@after () (Array (_ BitVec 160) (_ BitVec 256))) (assert (= call_count@after |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|)) :(declare-fun |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|              ()              (Array (_ BitVec 160) (_ BitVec 256))) (assert (= ((as const (Array (_ BitVec 160) (_ BitVec 256)))      #x8000000000000000000000000000000000000000000000000000000000000000)    |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|)) ;(declare-fun |__deepreason_expr_tmp_Array(BitVec(160), Array(BitVec(256), BitVec(256)))|              ()              (Array (_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256)))) (declare-fun global_storage@before              ()              (Array (_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256)))) (assert (= global_storage@before    |__deepreason_expr_tmp_Array(BitVec(160), Array(BitVec(256), BitVec(256)))|)) :(declare-fun |__deepreason_expr_tmp_Array(BitVec(160), Array(BitVec(256), BitVec(256)))|              ()              (Array (_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256)))) (assert (= (store ((as const                (Array (_ BitVec 160) (Array (_ BitVec 256) (_ BitVec 256))))             ((as const (Array (_ BitVec 256) (_ BitVec 256)))               #x8000000000000000000000000000000000000000000000000000000000000000))           #xfffffffffffffffffffffffffffffffffffffffd           (store ((as const (Array (_ BitVec 256) (_ BitVec 256)))                    #x8000000000000000000000000000000000000000000000000000000000000000)                  #x0000000000000000000000000000000000000000000000000000000000000000                  #x0000000000000000000000000000000000000000000000000000000000000001))    |__deepreason_expr_tmp_Array(BitVec(160), Array(BitVec(256), BitVec(256)))|)) ;(declare-fun |__deepreason_expr_tmp_BitVec(160)| () (_ BitVec 160)) (declare-fun VaultBasic_t2 () (_ BitVec 160)) (assert (= VaultBasic_t2 |__deepreason_expr_tmp_BitVec(160)|)) :(declare-fun |__deepreason_expr_tmp_BitVec(160)| () (_ BitVec 160)) (assert (= #xfffffffffffffffffffffffffffffffffffffffd    |__deepreason_expr_tmp_BitVec(160)|)) ;(declare-fun |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|              ()              (Array (_ BitVec 160) (_ BitVec 256))) (declare-fun nonces@after () (Array (_ BitVec 160) (_ BitVec 256))) (assert (= nonces@after |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|)) :(declare-fun |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|              ()              (Array (_ BitVec 160) (_ BitVec 256))) (assert (= ((as const (Array (_ BitVec 160) (_ BitVec 256)))      #x8000000000000000000000000000000000000000000000000000000000000000)    |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|)) ;(declare-fun |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|              ()              (Array (_ BitVec 160) (_ BitVec 256))) (declare-fun nonces@init () (Array (_ BitVec 160) (_ BitVec 256))) (assert (= nonces@init |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|)) :(declare-fun |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|              ()              (Array (_ BitVec 160) (_ BitVec 256))) (assert (let ((a!1 (store (store (store ((as const                                      (Array (_ BitVec 160) (_ BitVec 256)))                                   #x0000000000000000000000000000000000000000000000000000000000000000)                                 #x0000000000000000000000000000000000000000                                 #x0000000000000000000000000000000000000000000000000000000000000001)                          #xfffffffffffffffffffffffffffffffffffffffd                          #x0000000000000000000000000000000000000000000000000000000000000001)                   #x4000000000000000000000000000000000000000                   #x0000000000000100000000000000000000000000000000000001ffffffffffff)))   (= a!1 |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|))) ;(declare-fun |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|              ()              (Array (_ BitVec 160) (_ BitVec 256))) (declare-fun call_count@before () (Array (_ BitVec 160) (_ BitVec 256))) (assert (= call_count@before |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|)) :(declare-fun |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|              ()              (Array (_ BitVec 160) (_ BitVec 256))) (assert (= ((as const (Array (_ BitVec 160) (_ BitVec 256)))      #x8000000000000000000000000000000000000000000000000000000000000000)    |__deepreason_expr_tmp_Array(BitVec(160), BitVec(256))|)) ;(declare-fun |__deepreason_expr_tmp_BitVec(256)| () (_ BitVec 256)) (declare-fun keccak256_424 ((_ BitVec 424)) (_ BitVec 256)) (declare-fun f_input_0 () (_ BitVec 424)) (assert (= (keccak256_424 f_input_0) |__deepreason_expr_tmp_BitVec(256)|)) :&(declare-fun |__deepreason_expr_tmp_BitVec(424)| () (_ BitVec 424)) (assert (= #xb400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001    |__deepreason_expr_tmp_BitVec(424)|)) ->(declare-fun |__deepreason_expr_tmp_BitVec(256)| () (_ BitVec 256)) (assert (= #x000000000000000000000000fffffffffffffffffffffffffffffffffffffffd    |__deepreason_expr_tmp_BitVec(256)|)) &(declare-fun |__deepreason_expr_tmp_BitVec(256)| () (_ BitVec 256)) (assert (= #x0000000000000000000000000000000000000000000000000000000000000000    |__deepreason_expr_tmp_BitVec(256)|)) ;(declare-fun |__deepreason_expr_tmp_BitVec(256)| () (_ BitVec 256)) (declare-fun keccak256_512 ((_ BitVec 512)) (_ BitVec 256)) (declare-fun f_input_0 () (_ BitVec 512)) (assert (= (keccak256_512 f_input_0) |__deepreason_expr_tmp_BitVec(256)|)) :&(declare-fun |__deepreason_expr_tmp_BitVec(256)| () (_ BitVec 256)) (assert (= #x0000000000000000000000000000000000000000000000000000000000000000    |__deepreason_expr_tmp_BitVec(256)|)) ';
    const m = await loads_model(z3, str);
    // console.log(m);
  });

});